# =============================================================================
# Fleet Infrastructure - CI Validation
# =============================================================================
#
# Validates Kubernetes manifests before Flux deploys them:
# - YAML syntax validation
# - Kustomize build verification
# - Kubernetes schema validation (kubeconform)
# - Flux resource validation
#
# =============================================================================

name: Validate

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read

env:
  KUBERNETES_VERSION: "1.31.0"
  KUSTOMIZE_VERSION: "5.6.0"
  KUBECONFORM_VERSION: "0.6.7"
  FLUX_VERSION: "2.6.1"

jobs:
  # ---------------------------------------------------------------------------
  # YAML Lint - Check YAML syntax
  # ---------------------------------------------------------------------------
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@f21396f60a265edbc1f1f8aae5ab501df808f919 # v6.0.0

      - name: Install yamllint
        run: |
          python3 -m pip install --user yamllint==1.37.1

      - name: Run yamllint
        run: |
          ~/.local/bin/yamllint -d '{extends: relaxed, rules: {line-length: disable, comments: disable, truthy: {check-keys: false}}}' .

  # ---------------------------------------------------------------------------
  # Kustomize Build - Verify manifests render correctly
  # ---------------------------------------------------------------------------
  kustomize-build:
    name: Kustomize Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        path:
          - infrastructure/controllers
          - infrastructure/configs
          - apps/production
    steps:
      - name: Checkout
        uses: actions/checkout@f21396f60a265edbc1f1f8aae5ab501df808f919 # v6.0.0

      - name: Install kustomize
        run: |
          curl -sSLo /tmp/kustomize.tar.gz "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv${{ env.KUSTOMIZE_VERSION }}/kustomize_v${{ env.KUSTOMIZE_VERSION }}_linux_amd64.tar.gz"
          tar -xzf /tmp/kustomize.tar.gz -C /tmp
          sudo mv /tmp/kustomize /usr/local/bin/kustomize

      - name: Build ${{ matrix.path }}
        run: |
          set -euo pipefail
          echo "Building ${{ matrix.path }}..."
          kustomize build ${{ matrix.path }} > /dev/null
          echo "✓ ${{ matrix.path }} builds successfully"

  # ---------------------------------------------------------------------------
  # Kubeconform - Validate against Kubernetes schemas
  # ---------------------------------------------------------------------------
  kubeconform:
    name: Kubeconform
    runs-on: ubuntu-latest
    needs: kustomize-build
    strategy:
      matrix:
        path:
          - infrastructure/controllers
          - infrastructure/configs
          - apps/production
    steps:
      - name: Checkout
        uses: actions/checkout@f21396f60a265edbc1f1f8aae5ab501df808f919 # v6.0.0

      - name: Install kustomize
        run: |
          curl -sSLo /tmp/kustomize.tar.gz "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv${{ env.KUSTOMIZE_VERSION }}/kustomize_v${{ env.KUSTOMIZE_VERSION }}_linux_amd64.tar.gz"
          tar -xzf /tmp/kustomize.tar.gz -C /tmp
          sudo mv /tmp/kustomize /usr/local/bin/kustomize

      - name: Install kubeconform
        run: |
          curl -sSLo /tmp/kubeconform.tar.gz "https://github.com/yannh/kubeconform/releases/download/v${{ env.KUBECONFORM_VERSION }}/kubeconform-linux-amd64.tar.gz"
          tar -xzf /tmp/kubeconform.tar.gz -C /tmp kubeconform
          sudo mv /tmp/kubeconform /usr/local/bin/kubeconform

      - name: Validate ${{ matrix.path }}
        run: |
          set -euo pipefail
          echo "Validating ${{ matrix.path }}..."
          kustomize build ${{ matrix.path }} | \
            kubeconform \
              -strict \
              -ignore-missing-schemas \
              -kubernetes-version ${{ env.KUBERNETES_VERSION }} \
              -schema-location default \
              -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
              -summary
          echo "✓ ${{ matrix.path }} is valid"

  # ---------------------------------------------------------------------------
  # Flux Validation - Validate Flux-specific resources
  # ---------------------------------------------------------------------------
  flux-validate:
    name: Flux Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@f21396f60a265edbc1f1f8aae5ab501df808f919 # v6.0.0

      - name: Install Flux CLI
        run: |
          curl -sSLo /tmp/flux.tar.gz "https://github.com/fluxcd/flux2/releases/download/v${{ env.FLUX_VERSION }}/flux_${{ env.FLUX_VERSION }}_linux_amd64.tar.gz"
          tar -xzf /tmp/flux.tar.gz -C /tmp
          sudo mv /tmp/flux /usr/local/bin/flux

      - name: Validate Flux resources
        run: |
          set -euo pipefail

          echo "Running Flux pre-flight checks..."
          flux check --pre

          echo ""
          echo "Building cluster Flux Kustomizations from local manifests..."
          for ks in repositories infrastructure-controllers infrastructure-configs apps; do
            echo "Building: $ks"
            flux build kustomization "$ks" \
              --path ./clusters/production \
              --kustomization-file "./clusters/production/${ks}.yaml" \
              --dry-run > /dev/null
          done

          echo ""
          echo "✓ Flux resources validated"

  # ---------------------------------------------------------------------------
  # Diff - Show what would change (on PRs only)
  # ---------------------------------------------------------------------------
  diff:
    name: Diff
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout PR
        uses: actions/checkout@f21396f60a265edbc1f1f8aae5ab501df808f919 # v6.0.0
        with:
          path: pr

      - name: Checkout main
        uses: actions/checkout@f21396f60a265edbc1f1f8aae5ab501df808f919 # v6.0.0
        with:
          ref: main
          path: main

      - name: Install kustomize
        run: |
          curl -sSLo /tmp/kustomize.tar.gz "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv${{ env.KUSTOMIZE_VERSION }}/kustomize_v${{ env.KUSTOMIZE_VERSION }}_linux_amd64.tar.gz"
          tar -xzf /tmp/kustomize.tar.gz -C /tmp
          sudo mv /tmp/kustomize /usr/local/bin/kustomize

      - name: Diff repositories
        run: |
          echo "## Repository Source Changes" >> "$GITHUB_STEP_SUMMARY"
          echo '```diff' >> "$GITHUB_STEP_SUMMARY"

          kustomize build main/repositories > /tmp/main-repositories.yaml 2>/dev/null || echo "" > /tmp/main-repositories.yaml
          kustomize build pr/repositories > /tmp/pr-repositories.yaml 2>/dev/null || echo "" > /tmp/pr-repositories.yaml

          diff -u /tmp/main-repositories.yaml /tmp/pr-repositories.yaml >> "$GITHUB_STEP_SUMMARY" || true

          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Diff infrastructure controllers
        run: |
          echo "## Infrastructure Controller Changes" >> "$GITHUB_STEP_SUMMARY"
          echo '```diff' >> "$GITHUB_STEP_SUMMARY"

          kustomize build main/infrastructure/controllers > /tmp/main-controllers.yaml 2>/dev/null || echo "" > /tmp/main-controllers.yaml
          kustomize build pr/infrastructure/controllers > /tmp/pr-controllers.yaml 2>/dev/null || echo "" > /tmp/pr-controllers.yaml

          diff -u /tmp/main-controllers.yaml /tmp/pr-controllers.yaml >> "$GITHUB_STEP_SUMMARY" || true

          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Diff infrastructure configs
        run: |
          echo "## Infrastructure Config Changes" >> "$GITHUB_STEP_SUMMARY"
          echo '```diff' >> "$GITHUB_STEP_SUMMARY"

          kustomize build main/infrastructure/configs > /tmp/main-configs.yaml 2>/dev/null || echo "" > /tmp/main-configs.yaml
          kustomize build pr/infrastructure/configs > /tmp/pr-configs.yaml 2>/dev/null || echo "" > /tmp/pr-configs.yaml

          diff -u /tmp/main-configs.yaml /tmp/pr-configs.yaml >> "$GITHUB_STEP_SUMMARY" || true

          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Diff apps
        run: |
          echo "## Application Changes" >> "$GITHUB_STEP_SUMMARY"
          echo '```diff' >> "$GITHUB_STEP_SUMMARY"

          kustomize build main/apps/production > /tmp/main-apps.yaml 2>/dev/null || echo "" > /tmp/main-apps.yaml
          kustomize build pr/apps/production > /tmp/pr-apps.yaml 2>/dev/null || echo "" > /tmp/pr-apps.yaml

          diff -u /tmp/main-apps.yaml /tmp/pr-apps.yaml >> "$GITHUB_STEP_SUMMARY" || true

          echo '```' >> "$GITHUB_STEP_SUMMARY"
